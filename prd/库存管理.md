# 库存管理模块 (Inventory)

| 项目名称 | Nest (Home Digital Twin) |
| --- | --- |
| **版本号** | v0.7 (Final Inventory Core) |
| **文档状态** | **已定稿** |
| **核心理念** | 缓冲区管理，视觉堆叠 (Visual Stacking)，滑动窗口预测 |
| **最后更新** | 2026-02-10 |

## 1. 模块概述 (Module Overview)

### 1.1 核心价值

解决家庭物资的“断供焦虑”与“过度囤积”。
Nest 库存模块**不管理**正在使用中的物品（Open Item），只管理**储备库存 (Stockpile)**。

- **核心动作:** 用户从柜子里拿出一件新物品 -> 点击“开封” -> 库存 -1。
- **数据价值:** 利用“开封”频率，自动计算家庭消耗速率，预测囤货能撑多久。

### 1.2 性能设计原则

- **Local-First:** 所有 SKU 的消耗速率计算、预警判断、图表渲染均在客户端本地完成。

## 2. 用户交互 (User Interaction)

### 2.1 物品列表页 (Inventory List)

- **分组:** 按“类目 (Category)”展示 (e.g., 日化、食品)。
- **卡片内容:**
    - 名称 + 规格 (e.g., "维达卷纸 140g")。
    - **库存指示器:** 醒目的数字 (e.g., "剩余 12") + 状态颜色 (绿/黄/红)。
- **快捷操作:**
    - **[➖ 开封]:** 库存立即 -1。这是算法的核心数据源。
    - **[➕ 补货]:** 唤起补货弹窗。
    - **点击卡片:** 弹出 **物品详情悬浮页**。

### 2.2 [核心] 物品详情悬浮页 (Item Detail Sheet)

**定位:** 半屏模态卡片，承载深度信息与视觉特效。

### A. 顶部：视觉堆叠区 (Visual Stacking Header)

- **功能:** 将枯燥的数字转化为直观的物理堆积感。
- **逻辑:** 读取该品类的 `Emoji` (如 🧻) 和 `CurrentStock` (如 8)。
- **渲染:**
    - 在卡片背景层随机或网格排列 8 个 🧻 Icon。
    - **动态反馈:** 点击补货时，Icon 如下雨般增加；点击开封时，Icon 消失。
    - *性能上限:* 超过 30 个显示为密集纹理模式。

### B. 中部：库存趋势图 (Stock Flow Chart)

- **图表类型:** **阶梯折线图 (Step Line Chart)**。
- **X轴:** 时间 (过去 90 天)。
- **Y轴:** 库存数量。
- **视觉特征:**
    - **消耗 (Open):** 垂直向下的台阶 (红点)。
    - **补货 (Restock):** 垂直向上的台阶 (绿点)。
    - **预测线:** 虚线延伸至 X 轴，展示预计耗尽时间。

### C. 底部：管理操作区

- **补货/盘点:** 大号步进器 `[ - ] 12 [ + ]`，用于快速修正库存。
- **属性编辑:** 修改名称、阈值、类目。

### 2.3 补货交互

- **触发:** 列表页快捷按钮 或 详情页步进器。
- **逻辑:** `NewStock = CurrentStock + InputValue`。

## 3. 业务逻辑与算法 (Business Logic)

### 3.1 核心算法：滑动窗口消耗率 (Rolling Consumption Rate)

针对“多点并行消耗”场景（如多房间用纸），计算单位时间内的总吞吐量。

- **公式:**$$DailyRate = \frac{\sum(\text{OpenCounts in Window})}{\text{DaysElapsed}} \times \text{FamilyFactorAdjustment}$$
- **参数:**
    - `WindowDays`: 滑动窗口大小，默认为 60 天。
    - `FamilyFactorAdjustment`:
        - 若物品标记为 `is_shared` (共享)，且家庭人数发生变化，历史 Rate 需乘以 (新人数/旧人数) 进行预估修正。

### 3.2 预警逻辑 (Alert Logic)

系统每次操作后计算：

1. **计算预计剩余天数:** $DaysLeft = CurrentStock / DailyRate$。
2. **触发条件 (OR):**
    - **硬阈值:** `CurrentStock <= Threshold` (默认为 1)。
    - **软预警:** `DaysLeft <= 3` (3天内耗尽)。
3. **输出:** 推送至首页 Dashboard 的“智能管家提示”。

### 3.3 冷启动策略

- **记录不足 2 次开封:** 显示 "学习消耗习惯中..."，不显示预测天数。

## 4. 数据定义 (Data Schema)

```
{
  "inventory_module": {
    "categories": [
       { "id": "c1", "name": "日用纸品", "emoji": "🧻" },
       { "id": "c2", "name": "洗护用品", "emoji": "🧴" }
    ],
    "items": [
      {
        "id": "i_001",
        "name": "抽纸",
        "category_id": "c1",
        "current_stock": 5,
        "threshold": 1,
        "is_shared": true,
        "history_logs": [
           // 必须记录动作类型以绘制阶梯图
           { "ts": 1709251200, "action": "RESTOCK", "delta": 10, "balance": 10 },
           { "ts": 1709337600, "action": "OPEN", "delta": -1, "balance": 9 }
        ]
      }
    ]
  }
}

```